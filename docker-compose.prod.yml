# ============================================
# Production Docker Compose Configuration
# ============================================
# This file contains production-ready security settings
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

version: '3.8'

services:
  mongodb:
    # Security: Use specific image version (not latest)
    image: mongo:7.0
    # Security: Remove default ports - MongoDB only accessible internally
    ports: []
    # Security: Enable MongoDB authentication
    command: >
      mongod
      --auth
      --bind_ip_all
      --wiredTigerCacheSizeGB 1
    # Security: Additional MongoDB security settings
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
    # Security: Use TLS for MongoDB connections (if certificates available)
    # volumes:
    #   - ./certs/mongodb.pem:/etc/ssl/mongodb.pem:ro
    # command: >
    #   mongod
    #   --auth
    #   --bind_ip_all
    #   --tlsMode requireTLS
    #   --tlsCertificateKeyFile /etc/ssl/mongodb.pem

  app:
    # Security: Use specific image tag
    image: chat_commerce:latest
    # Security: Bind to specific interface (use reverse proxy in production)
    ports:
      - "127.0.0.1:${APP_PORT:-3000}:3000"
    # Security: Additional environment variables for production
    environment:
      NODE_ENV: production
      # Security: Enable strict CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      # Security: Enable rate limiting
      RATE_LIMIT_ENABLED: "true"
      # Security: Enable request logging
      REQUEST_LOGGING: "true"
      # Security: Disable debug mode
      DEBUG: "false"
    # Security: Use read-only filesystem
    read_only: true
    # Security: Additional tmpfs mounts
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /var/run:noexec,nosuid,size=10m
      - /app/uploads:noexec,nosuid,size=1g

networks:
  chat_commerce_network:
    # Security: Use overlay network for multi-host deployments
    # driver: overlay
    # Security: Enable encryption
    driver_opts:
      encrypted: "true"
